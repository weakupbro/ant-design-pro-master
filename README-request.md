# 工厂订单管理系统

## 技术栈

### 前端技术栈
- **框架和库**
  - React.js
  - Ant Design Pro（UI 框架）
  - UmiJS（企业级 React 应用框架）
  - TypeScript（类型系统）
  - Moment.js（日期处理）
  - Axios（HTTP 请求）

### 后端技术栈
- **运行环境**
  - Node.js
- **框架**
  - Express.js（Web 服务器框架）
- **主要功能**
  - RESTful API
  - 数据验证
  - 文件处理
  - 跨域处理（CORS）

### 数据库
- **数据库系统**
  - MySQL（使用 mysql2 驱动）
- **表结构**
  - OrderA（订单主表）
  - OrderB（付款信息表）

### 通信
- 前后端通信：RESTful API
- 数据格式：JSON
- 端口配置：
  - 前端：8000
  - 后端：3003
  - 数据库：默认 3306

## 功能说明

### A表格（订单主表）
#### 字段定义
- 订单号（字符串）
- 产品名称（汉字）
- 下单日期（时间类型）
- 货好日期（时间类型）
- 首发时间（时间类型）
- 总金额（数字）
- 总数量（数字）
- 单位件数（数字）
- 箱数（数字）
- 本次发货（数字）
- 已发货（数���）
- 未发货（数字）

#### 业务逻辑
1. 新增订单：
   - 所有字段初始值均为空
   - 订单号不能重复，重复时提示错误并阻止保存
   - 订单号和产品名称为必填项
   - 总金额只能在新建订单时输入，后续编辑时不可修改
   - 总金额必须大于0

2. 编辑订单：
   - 总金额字段在编辑时为只读状态
   - 编辑其他字段时不进行总金额验证
   - 保存时自动保持原有总金额不变
   - 其他字段可以正常编辑和保存

3. 发货数量处理：
   - 输入本次发货数量后，已发货数量自动累加
   - 未发货数量 = 总箱数 - 已发货数量
   - 所有数量字段都转换为整数处理
   - 数量不能为负数

4. 发货数量验证：
   - 每次发货时检查：已发货 + 本次发货 ≤ 总箱数
   - 如果发货数量超过总箱数：
     - 显示错误提示消息
     - 提示包含：总箱数、已发货数量、本次发货数量
     - 阻止数据保存
     - 保持原有数据不变

5. 日期处理：
   - 支持字符串格式日期
   - 支持 Moment 对象格式日期
   - 日期格式统一为：YYYY-MM-DD

6. 金额处理：
   - 金额允许包含小数
   - 金额不能为负数
   - 总金额只能在新建订单时输入一次，后续不允许修改
   - 创建订��时自动同步到 B 表的未付金额
   - 编辑订单时保持原有总金额不变

7. 数据联动：
   - 创建新订单时自动在 B 表创建对应记录
   - 更新订单时同步更新 B 表的基本信息（订单号、产品名称、下单日期）
   - 删除订单时通过外键关联自动删除 B 表对应记录

8. 数据展示：
   - 表格按 ID 降序排序，新订单显示在最上方
   - 支持按订单号和产品名称搜索
   - 表格底部添加横向滚动条
   - 总金额显示保留两位小数

### B表格（付款信息表）
#### 字段定义（按显示顺序）
- 订单号（字符串，外键关联A表，固定在左侧）
- 产品名称（汉字）
- 下单时间（时间类型，显示格式：YYYY-MM-DD）
- 总金额（数字，decimal(10,2)，从A表同步）
- 本次付款（数字，decimal(10,2)）
- 已付金额（数字，decimal(10,2)）
- 未付金额（数字，decimal(10,2)）
- 应付款金额（数字，根据付款阶段动态计算）
- 应付款类型（定金、首发款、余款、已付清）
- 订单截图（图片类型，支持jpg、jpeg、png、gif格式）
- 更新时间（timestamp类型，自动更新）
- 操作（固定在右侧）

#### 业务逻辑
1. 付款金额处理：
   - 已付款金额初始值为0
   - 每次付款时，已付款金额 = 原已付金额 + 本次付款
   - 未付金额 = 总金额 - 已付款金额
   - 本次付款在刷新页面时重置为0
   - 所有金额字段显示时保留两位小数

2. 应付款金额计算：
   - 定金阶：总金额的30%
   - 首发款阶段：总金额的30%
   - 余款阶段：总金额的40%
   - 已付清：0

3. 应付款类型判断：
   - 使用浮点数比较时允许0.01的误差
   - 根据已付金额占总金额的比例判断：
     - 比例为0：定金阶段
     - 比例为30%：首发款阶段
     - 比例为60%：余款阶段
     - 比例为100%：已付清

4. 付款验证：
   - 每个阶段只能支付对应比例的金额
   - 定金阶段只能支付总金额的30%
   - 首发款阶段只能支付总金额的30%
   - 余款阶段只能支付总金额的40%
   - 验证失败时显示具体的错误信息和应付金额

5. 数据同步：
   - A表新建订单时，总金额同步到B表（仅同步一次）
   - B表总金额字段不可手动修改
   - A表后续修改总金额不会影响B表
   - 仅同步订单号、产品名称、下单日期等基本信息

6. 数据显示：
   - 表格按ID降序排序
   - 订单号列固定在左侧
   - 操作列固定在右侧
   - 列宽经过优化，提高可读性
   - 金额字段统一显示两位小数
   - 日期字段格式化为 YYYY-MM-DD

7. 错误处理：
   - 使用事务确保数据一致性
   - 付款验证失败时自动回滚
   - 显示详细的错误提示信息
   - 异常情况下保持原有数据不变

8. 性能优化：
   - 使用数据库事务处理
   - 优化前端渲染逻辑
   - 减少不必要的数据刷新
   - 优化浮点数比较逻辑

9. 用户体验：
   - 清晰的列表布局
   - 直观的付款阶段显示
   - 准确的金额计算
   - 及时的错误提示
   - 便捷的操作按钮

## 更新日志
- 2023-12-04: 初始版本
- 2023-12-04: 移除B表金额两位小数限制
- 2023-12-04: 移除B表对A表发货数量的检查
- 2023-12-04: 添加A表格发货数量超限提醒和阻止功能
- 2023-12-04: 修改B表格"付款类型"为"应付款类型"，新增"应付款金额"列
- 2023-12-05: 完善付款验证逻辑，修复浮点数比较问题，实现准确的分阶段付款功能
- 2023-12-05: 优化B表显示，调整列宽和列顺序，增强可读性
- 2023-12-05: 修复付款金额累加计算问题，确保刷新页面时数据正确
- 2023-12-06: 优化字段命名，"准备日期"改为"货好日期"，"数量"改为"总数量"
- 2023-12-06: 新增总金额字段限制，只允许在新建订单时输入一次
- 2023-12-06: 修改总金额同步逻辑，仅在B表初始化时同步一次
- 2023-12-06: 新增订单截图功能，支持图片上传和预览
